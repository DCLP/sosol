:javascript
  
  //these funcions have to be in the haml file because of the ruby stuff in them needs to be handled on view load
  
  var sendBack = "";
  
  function getHGVNumber(identifierIn){
 
    request_url = "#{url_for(:controller => 'ajax_proxy', :only_path => true)}" + '/hgvnum/';
    
    //made asynchronous false because next call to xsugar was firing before response got back
    new Ajax.Request(request_url, {
      method: 'get',
      parameters: $H({identifier: identifierIn}),
      asynchronous : false,
      onSuccess: function(response) {
        checkResponse = response.responseText;
        if (checkResponse.search("bad") > -1 || checkResponse.search("no related") > -1) {
          alert("Oops, there's been an error during Ajax call." + response.responseText);
          sendBack = 'bad return code or invalid identifier';
        }
        else {
          sendBack = response.responseText;
        }
      },
      onFailure: function(response) {
        // reload after 10 seconds if we failed, should ONLY be used if JCS cache is working
        setTimeout("getHGVNumber(" + identifierIn + ")",10000);
      }
    });
    return sendBack;
  }
  
#main
  = csrf_meta_tag
  = javascript_include_tag :defaults
  = javascript_include_tag 'commentary'
    
  .site
    = stylesheet_link_tag 'helper'
    #gapsize{:class => "helperpop"}
      = render :partial => 'commentary_markup_warn'
      %h3 Create Link to PN Publication
      %h4 Regular or Bibliograpy Style
      = render :partial => "publications/publication_selector", :locals => { :emend => :helper }
      #extent_left
        %input{ :type => "text", :class => "choosetext", :id => "insertlink_freetext", :size => "40"}Link Text
      #extent_left
        %br
        %form{:name => "bibl_check"}
          %input{ :type => "checkbox", :class => "insertlink_check_c", :id => "insertlink_bibl", :name => "insertlink_check_n", :value => "insertlink_bibl_v", :enabled => "true"}Check if this is a bibliograpy link but no other data needed
          %br
      #extent_left
        %h4 If any of the text boxes below are filled in, the helper will assume you want a bibliography style link
        %input{ :type => "text", :class => "choosetext", :id => "insertlink_bs_page", :size => "10"}Bibliograpy Page
        %br
        %input{ :type => "text", :class => "choosetext", :id => "insertlink_bs_line", :size => "10"}Bibliograpy Line
        %br
        %input{ :type => "text", :class => "choosetext", :id => "insertlink_bs_vol", :size => "10"}Bibliograpy Volume
        %br
        %input{ :type => "text", :class => "choosetext", :id => "insertlink_bs_issue", :size => "10"}Bibliograpy Issue
        %br
        %input{ :type => "text", :class => "choosetext", :id => "insertlink_bs_chapter", :size => "10"}Bibliograpy Chapter
      #button_left
        %button{ :type => "button", :onclick=> "insertLinkPN()" }Insert
        &nbsp
        %button{:type => "button", :onclick => "closeHelper()"}Close
